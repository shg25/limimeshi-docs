# Feature Specification: お気に入り登録（Favorites）

**Feature Branch**: `003-favorites`  
**Created**: 2025-11-16  
**Updated**: 2025-11-28  
**Status**: Draft  
**Input**: User description: "ログインユーザーがチェーン店をお気に入り登録・解除できる機能（Androidアプリ）。お気に入り登録したチェーンは002のチェーン店一覧フィルタで使用される。お気に入り状態はFirestoreに永続化され、複数デバイス間で同期される。Phase2 MVPで実装。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - チェーン店のお気に入り登録・解除 (Priority: P1)

ログインユーザーがチェーン店をお気に入り登録・解除でき、お気に入り状態が即座にUIに反映される。お気に入り登録したチェーンは002のチェーン店一覧フィルタで使用される。

**Why this priority**: お気に入り機能はチェーン店一覧フィルタ（002）の前提条件。ユーザーが関心のあるチェーンを登録できなければフィルタ機能が使えない。

**Independent Test**: お気に入り登録・解除が正しく動作し、状態がFirestoreに永続化され、UIに即座に反映されれば、独立して価値を提供できる。

**Acceptance Scenarios**:

1. **Given** ログインユーザーがチェーン店一覧画面を表示, **When** チェーン店の「お気に入り登録」ボタンをタップ, **Then** お気に入り登録が完了し、ボタンが「お気に入り解除」に変わる
2. **Given** ログインユーザーがチェーン店をお気に入り登録済み, **When** 「お気に入り解除」ボタンをタップ, **Then** お気に入り解除が完了し、ボタンが「お気に入り登録」に変わる
3. **Given** ログインユーザーがチェーン店をお気に入り登録済み, **When** ユーザーが別デバイスでログイン, **Then** お気に入り登録状態が同期されている
4. **Given** ログインユーザーがお気に入り登録・解除操作を実行, **When** 操作が完了, **Then** 1秒以内にUIに反映される
5. **Given** 未ログインユーザー, **When** チェーン店一覧画面を表示, **Then** お気に入り登録ボタンは非表示または無効化されている
6. **Given** ログインユーザーがお気に入り登録を試行, **When** ネットワークエラーが発生, **Then** エラーメッセージが表示され、操作は完了しない

---

### User Story 2 - お気に入り登録数の表示 (Priority: P2)

各チェーン店のお気に入り登録数を表示し、人気のチェーンを視覚的に示す。

**Why this priority**: お気に入り登録数は人気指標として有用だが、登録・解除機能（P1）がなければ表示できない。UX向上のための補助的機能。

**Independent Test**: お気に入り登録数が正しくカウントされ、各チェーン店に表示されれば、独立して価値を提供できる。

**Acceptance Scenarios**:

1. **Given** チェーン店が複数ユーザーにお気に入り登録済み, **When** チェーン店一覧画面を表示, **Then** 各チェーン店のお気に入り登録数が表示される
2. **Given** ユーザーがお気に入り登録を実行, **When** 操作が完了, **Then** お気に入り登録数が即座に+1される
3. **Given** ユーザーがお気に入り解除を実行, **When** 操作が完了, **Then** お気に入り登録数が即座に-1される
4. **Given** チェーン店のお気に入り登録数が0件, **When** チェーン店一覧画面を表示, **Then** お気に入り登録数は表示されない（または「0」と表示）

---

### Edge Cases

- **未ログインユーザー**: お気に入り登録ボタンは非表示または無効化（Phase2では未ログインユーザー向けローカルストレージ対応なし）
- **重複登録防止**: 同じチェーン店を複数回お気に入り登録しようとした場合、既に登録済みであることを示す（エラーではなく、ボタンが既に「解除」状態）
- **ネットワークエラー**: お気に入り登録・解除操作中にネットワークエラーが発生した場合、エラーメッセージを表示し、操作を中断
- **同時操作**: 複数デバイスから同時にお気に入り登録・解除操作を行った場合、Firestoreの Last Write Wins で自動解決
- **お気に入り登録数の一貫性**: お気に入り登録数は集約データとして管理し、登録・解除時に増減させる（リアルタイムカウントではなく、非正規化データとして管理）
- **削除されたチェーン店**: 管理画面でチェーン店が削除された場合、関連するお気に入りレコードも削除される（カスケード削除、Phase2では手動削除のみ）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはログインユーザーがチェーン店をお気に入り登録できなければならない
- **FR-002**: システムはログインユーザーがチェーン店のお気に入り登録を解除できなければならない
- **FR-003**: システムはお気に入り登録・解除操作を1秒以内に完了しなければならない
- **FR-004**: システムはお気に入り登録状態をFirestoreに永続化し、複数デバイス間で同期しなければならない
- **FR-005**: システムは未ログインユーザーに対してお気に入り登録機能を提供してはならない（ボタン非表示または無効化）
- **FR-006**: システムはお気に入り登録・解除操作のエラー時に適切なエラーメッセージを表示しなければならない
- **FR-007**: システムは各チェーン店のお気に入り登録数を表示しなければならない
- **FR-008**: システムはお気に入り登録・解除操作時にお気に入り登録数を即座に増減しなければならない
- **FR-009**: システムは同じチェーン店への重複登録を防止しなければならない（UIで「既に登録済み」状態を示す）
- **FR-010**: システムはお気に入り登録データを002のチェーン店一覧フィルタで利用できるようにしなければならない

### Key Entities

- **Favorite（お気に入り）**: ユーザーとチェーン店の関連を表す。ユーザーID、チェーンID、登録日時を持つ。ユーザーごとにお気に入りチェーンを管理する。
- **Chain（チェーン店）**: お気に入り登録の対象エンティティ。お気に入り登録数（集約データ）を持つ。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: お気に入り登録・解除操作が1秒以内に完了する（モバイル4G環境）
- **SC-002**: お気に入り登録・解除操作が正常に完了する確率が99%以上である
- **SC-003**: お気に入り登録状態が複数デバイス間で5秒以内に同期される
- **SC-004**: 未ログインユーザーがお気に入り登録を試みた場合、100%の確率で拒否される
- **SC-005**: お気に入り登録数の表示が登録・解除操作後1秒以内に更新される

## Assumptions *(optional)*

- お気に入り機能は002のチェーン店一覧フィルタと連携する
- Phase2ではログイン必須（未ログインユーザー向けローカルストレージ対応はPhase3以降）
- お気に入り登録数は集約データとして管理（非正規化データ）
- ユーザーは平均5〜10件のチェーンをお気に入り登録すると想定
- お気に入り登録・解除の頻度は低い（月に数回程度）
- Phase2では16チェーンのみが対象（管理画面で登録されたチェーンのみ）
- Phase2ではAndroidアプリを優先（Webアプリ対応はPhase3以降）

## Out of Scope *(optional)*

以下はPhase2 MVPの対象外：

### フロントエンド機能（Phase3以降）

- **未ログインユーザー向けローカルストレージ対応**: ローカルストレージにお気に入り登録を保存し、ログイン時にFirebaseに同期する機能。Phase2ではログイン必須。
- **お気に入り一覧ページ**: お気に入り登録したチェーン店の専用一覧ページ。Phase2では002のフィルタで代替。
- **お気に入り登録時の通知**: お気に入り登録したチェーンの新キャンペーンが追加されたときの通知機能。
- **お気に入りソート**: お気に入り登録日時順、お気に入り登録数順などのソート機能。
- **お気に入り登録理由**: お気に入り登録時にメモやタグを追加する機能。
- **Webアプリ**: Phase3以降で実装予定（Phase2はAndroidアプリ優先）

### その他の機能

- **お気に入り登録の推奨**: AIやルールベースでお気に入り登録を推奨する機能。
- **ソーシャル機能**: 他のユーザーのお気に入りを見る機能。
- **お気に入りグループ**: お気に入りチェーンをグループ化する機能。
- **お気に入りエクスポート**: お気に入りリストをエクスポートする機能。
