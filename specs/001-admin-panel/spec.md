# Feature Specification: 管理画面（Admin Panel）

**Feature Branch**: `001-admin-panel`  
**Created**: 2025-11-10  
**Status**: Draft  
**Input**: User description: "React Adminを使用した管理画面。チェーン店、キャンペーン、タグの手動登録・編集・削除機能を提供。管理者認証（メール+パスワード、Custom Claims）必須。手動データ登録の基盤となる最優先機能。Phase2 MVPで実装。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - チェーン店の管理 (Priority: P1)

管理者が新しいチェーン店をシステムに登録し、既存のチェーン店情報を更新できる。チェーン店は全てのキャンペーンの親エンティティであり、これがなければキャンペーン登録ができないため最優先。

**Why this priority**: チェーン店はキャンペーンの親エンティティであり、キャンペーン登録の前提条件。これがなければサービス全体が機能しない。

**Independent Test**: チェーン店の登録・一覧表示・編集が完全に動作すれば、この機能は独立して価値を提供できる。

**Acceptance Scenarios**:

1. **Given** 管理者がログイン済み, **When** 新しいチェーン店（名前、ふりがな、公式URL、ロゴURL）を入力して保存, **Then** チェーン店が一覧に表示され、システムに永続化される
2. **Given** チェーン店が1件以上登録済み, **When** 管理者がチェーン店一覧を表示, **Then** 全てのチェーン店がふりがな順（50音順）で表示される
3. **Given** チェーン店が登録済み, **When** 管理者がチェーン店情報を編集して保存, **Then** 変更が即座に反映される
4. **Given** チェーン店が登録済み, **When** 管理者がチェーン名で検索, **Then** 該当するチェーン店のみが表示される
5. **Given** チェーン店登録フォーム, **When** 管理者がチェーン名またはふりがなを未入力で保存, **Then** エラーメッセージが表示され保存できない

---

### User Story 2 - キャンペーンの管理 (Priority: P1)

管理者がキャンペーンを手動で登録し、販売開始日時と販売終了日時を管理できる。これがサービスの核心的価値であり、チェーン店と並んで最優先。

**Why this priority**: キャンペーン情報の提供がサービスの主要価値。これがなければユーザーに提供する情報がない。

**Independent Test**: キャンペーンの登録・一覧表示・編集・削除が完全に動作し、チェーン店との紐付けが正しく機能すれば、独立して価値を提供できる。

**Acceptance Scenarios**:

1. **Given** 管理者がログイン済みでチェーン店が1件以上登録済み, **When** 新しいキャンペーン（所属チェーン、キャンペーン名、販売開始日時）を入力して保存, **Then** キャンペーンが一覧に表示され、ステータスが自動判定される
2. **Given** キャンペーンが1件以上登録済み, **When** 管理者がキャンペーン一覧を表示, **Then** 全てのキャンペーンがチェーン名、キャンペーン名、販売開始日時、販売終了日時、ステータス（自動判定）で表示され、販売開始日時の降順（新しい順）で並ぶ
3. **Given** キャンペーンが登録済み, **When** 管理者がキャンペーン情報を編集（販売終了日時追加、説明追加など）して保存, **Then** 変更が即座に一般向けアプリに反映される
4. **Given** キャンペーンが登録済み, **When** 管理者がキャンペーンを削除（確認ダイアログ経由）, **Then** キャンペーンが一覧から削除される
5. **Given** キャンペーンが複数登録済み, **When** 管理者がキャンペーン名またはチェーン名で検索, **Then** 該当するキャンペーンのみが表示される
6. **Given** キャンペーン登録フォーム, **When** 管理者がキャンペーン名、所属チェーン、または販売開始日時を未入力で保存, **Then** エラーメッセージが表示され保存できない
7. **Given** キャンペーン登録フォーム, **When** 管理者が販売終了日時を未入力で保存, **Then** キャンペーンは販売終了日時なしで保存され、ステータスが「予定」または「開始から◯日経過」と自動判定される
8. **Given** 販売終了日時が未入力で販売開始日時から1ヶ月以上経過, **When** 管理者がキャンペーン一覧を表示, **Then** ステータスに経過期間（「開始から1ヶ月経過」「開始から2ヶ月経過」など）が表示される

---

### User Story 3 - 管理者認証 (Priority: P1)

管理者のみがシステムにアクセスでき、一般ユーザーは管理画面にアクセスできない。全ての管理機能のセキュリティ基盤。

**Why this priority**: セキュリティは非交渉原則。管理者認証なしでは不正なデータ登録・改ざんのリスクがある。

**Independent Test**: 管理者でログインできること、一般ユーザーがアクセスできないこと、ログアウトが機能することを確認できれば、独立して価値を提供できる。

**Acceptance Scenarios**:

1. **Given** 管理者アカウントが登録済み, **When** 管理者がメールアドレスとパスワードでログイン, **Then** 管理画面のダッシュボードが表示される
2. **Given** 一般ユーザーまたは未認証ユーザー, **When** 管理画面のURLにアクセス, **Then** アクセスが拒否される（ログイン画面にリダイレクト）
3. **Given** 管理者がログイン済み, **When** 管理者がログアウトボタンをクリック, **Then** ログアウトされ、ログイン画面に戻る
4. **Given** 管理者ログインフォーム, **When** 誤ったパスワードでログイン試行, **Then** エラーメッセージが表示され、ログインできない

---

### Edge Cases

- **チェーン店削除**: Phase2では削除機能を提供しない。16店舗のみで削除頻度が極めて低いため、誤削除のリスクを避ける。必要な場合はFirestoreコンソールから手動削除。
- **同名キャンペーンの区別**: 同じチェーン店に同じキャンペーン名が複数登録される場合、販売開始日時が異なれば別レコードとして扱う（例：グラコロ 2024年版と2025年版は完全に別キャンペーン）。管理画面・フロントエンドともにチェーン店名、キャンペーン名、販売開始日時を併記する。
- **過去日付の販売開始日時**: 警告なしで許可する。流行後に遡って登録するケースを想定。
- **X Post削除リスク**: キャンペーンに紐付けたX PostをPost作成者が削除した場合、フロントエンドで表示できなくなる。外部依存の制約として受け入れる。
- **ネットワークエラー**: React Adminのデフォルト動作に従う。同期処理（保存・削除）はエラーダイアログを表示し、非同期処理はエラー状態を表示する。詳細は plan.md で決定。
- **同時編集の競合**: Phase2は1名運用のため特別な考慮は不要。Firestoreの Last Write Wins で自動解決。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムは管理者がメールアドレスとパスワードでログインできなければならない
- **FR-002**: システムは管理者のみがチェーン店、キャンペーンの登録・編集・削除を実行できなければならない
- **FR-003**: システムは一般ユーザーまたは未認証ユーザーの管理画面アクセスを拒否しなければならない
- **FR-004**: システムはチェーン店の新規登録・編集機能を提供しなければならない（チェーン名、ふりがな、公式URL、ロゴURL）
- **FR-005**: システムはキャンペーンの新規登録・編集・削除機能を提供しなければならない（所属チェーン、キャンペーン名、販売開始日時は必須、説明・X Post URL・販売終了日時は任意）
- **FR-006**: システムはチェーン店一覧、キャンペーン一覧を表示しなければならない
- **FR-007**: システムはチェーン名でチェーン店を検索できなければならない
- **FR-008**: システムはキャンペーン名またはチェーン名でキャンペーンを検索できなければならない
- **FR-009**: システムは販売終了日時を任意項目として扱い、未入力での保存を許可しなければならない
- **FR-010**: システムは削除操作時に確認ダイアログを表示しなければならない
- **FR-011**: システムは必須項目が未入力の場合、保存を拒否しなければならない
- **FR-012**: システムは保存・削除エラー時に適切なエラーメッセージを表示しなければならない
- **FR-013**: システムはキャンペーンのステータスを販売開始日時と販売終了日時から自動判定しなければならない（予定/開始から◯日経過/開始から◯ヶ月以上経過/終了）
- **FR-014**: システムはチェーン店登録時にふりがなを必須項目として入力させなければならない
- **FR-015**: システムはキャンペーン登録時に販売開始日時を必須項目として入力させなければならない
- **FR-016**: システムは販売終了日時が未入力で販売開始日時から1ヶ月以上経過している場合、管理画面でステータスに経過期間を表示しなければならない（1ヶ月経過、2ヶ月経過など）
- **FR-017**: システムはキャンペーン一覧を販売開始日時の降順（新しい順）で表示しなければならない
- **FR-018**: システムは販売終了日時が入力された場合、販売開始日時より後であることを検証しなければならない

### Key Entities

- **Chain（チェーン店）**: 大手チェーン店の情報を表す。チェーン名、ふりがな、公式サイトURL、ロゴ画像URLを持つ。キャンペーンの親エンティティ。
- **Campaign（キャンペーン）**: キャンペーンの情報を表す。キャンペーン名、所属チェーンID、説明、X Post URL、販売開始日時（必須）、販売終了日時（任意）を持つ。ステータスは日時から自動判定される。必ずチェーン店に紐付く。
- **Admin（管理者）**: システム管理者の情報を表す。管理者ID、表示名、メールアドレス、認証方法を持つ。管理者権限を持つユーザー。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 管理者が新しいチェーン店を2分以内に登録できる
- **SC-002**: 管理者が新しいキャンペーンを2分以内に登録できる
- **SC-003**: 管理画面のページ読み込み時間が3秒以内である（外部サービス埋め込み部分を除く）
- **SC-004**: 保存・削除操作が1秒以内に完了する
- **SC-005**: 一般ユーザーが管理画面にアクセスを試みたとき、100%の確率でアクセスが拒否される
- **SC-006**: 管理者が誤ってデータを削除しようとしたとき、100%の確率で確認ダイアログが表示される
- **SC-007**: 必須項目が未入力の場合、100%の確率で保存が拒否され、明確なエラーメッセージが表示される
- **SC-008**: キャンペーンの変更が保存後、即座に一般向けアプリに反映される（5秒以内）

## Assumptions *(optional)*

- 管理者は1名から開始し、Phase3以降で複数名に拡大する想定
- チェーン店は16店舗から開始し、Phase3以降で追加される可能性がある
- キャンペーンは各チェーン店あたり平均10件程度を想定
- 管理画面の利用はPC（デスクトップ）を主とし、モバイル最適化は優先度が低い
- キャンペーンの視覚情報はX Post埋め込みで提供する（Phase3以降）。公式画像の利用はチェーン店との提携後に検討

## Out of Scope *(optional)*

以下はPhase2 MVPの対象外：

### 管理画面機能（Phase3以降）

- **タグ管理**: チェーン店を分類するためのタグ登録・編集・削除機能。タグはフィルタリングとカテゴリ分類に使用される。Phase3以降でテンプレートアイコンとの紐付けも検討。DBマイグレーションリスクは低い（スキーマレスなので後から追加容易）。
- **入力補助機能**: 管理者がキャンペーン登録時に過去の類似キャンペーンから入力候補を表示する機能。運用効率の改善だが、実際に使い始めてから改善案を検討する方が効率的。
- **終了キャンペーンの一括更新機能**: 複数キャンペーンの販売終了日時を一括で設定する機能。

### フロントエンド機能（Phase3以降、タグより優先度高）

- **X Post埋め込み表示**: キャンペーン詳細画面でX Postを埋め込み表示する機能。Phase2では管理画面でX Post URLを登録できるが、フロントエンドでの表示はPhase3以降。
- **テンプレートアイコン**: 特定のタグに紐付けてアイコンを表示する機能。タグ管理機能と同時実装を想定。

### その他の機能

- **ユーザー管理**: 一般ユーザーの一覧表示、削除、統計情報
- **レビュー管理**: 一覧表示、削除、モデレーション（Phase3で実装予定）
- **ダッシュボード**: KPI、アクセス解析、コスト監視
- **2要素認証**: Phase2リリース後に追加検討
- **モバイル最適化**: 管理画面のモバイル対応
- **チェーン店一覧のソート機能**: お気に入り数ランキングなど
- **画像URL**: 公式画像の直接利用はチェーン店との提携後に検討（法的リスク回避）
- **Webアプリ（一般ユーザー向け）**: Phase3以降で実装予定（Phase2はAndroidアプリ優先）
