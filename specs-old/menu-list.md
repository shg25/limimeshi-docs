# 機能設計書：メニュー一覧機能

作成日：2025/10/26

---

## 1. 概要（Overview）

### 機能名

メニュー一覧機能

### 目的

チェーン店の期間限定メニューを一覧表示し、ユーザーが「今日は何を食べようか」という意思決定を支援する

### 対象ユーザー

- 堅実派会社員（45歳男性）：平日ランチで「今日は何を食べようか」と迷ったとき
- 情報感度の高い中高生（16歳女子）：友達と「今どこのチェーン店で何が出てるか」を調べたいとき
- 時間を有効活用したい営業マン（32歳男性）：アポとアポの合間に「近くのチェーン店で何か食べよう」と考えたとき
- 気分転換を求めるOL（28歳女性）：通勤前・昼休み・帰宅時に「今日はカフェで何を買おう」と考えたとき

### Phase2（MVP）での実装範囲

- 期間限定メニューの一覧表示
- チェーン店別のフィルタリング
- お気に入り登録したチェーンのみの一覧表示
- メニュー詳細表示（メニュー名、説明、価格、販売期間、画像）
- チェーン詳細ページでの通常メニュー表示

### Phase3以降で追加予定

- 位置情報検索（近くのチェーン店の期間限定メニュー）
- タグ別フィルタリング（「ハンバーガー」「カフェ」「丼」など）
- 販売終了予定メニューの強調表示
- ユーザーからの販売終了報告機能

---

## 2. ユーザーストーリー（User Stories）

### US-1：期間限定メニューを一覧で確認したい

**ユーザー**：堅実派会社員（45歳男性）

**ストーリー**：
```
平日ランチ前に、スマホでリミメシを開く
トップページで16チェーン店の期間限定メニューが一覧で表示される
「あ、松屋で新しい定食が出てる」と気づく
メニュー詳細を確認（価格、販売期間、説明）
「よし、今日はこれにしよう」と決める
```

**受入基準**：
- トップページに期間限定メニューが一覧表示される
- メニュー名、チェーン名、画像、価格が表示される
- メニューをタップすると詳細ページに遷移する

### US-2：お気に入りのチェーン店のメニューだけ見たい

**ユーザー**：情報感度の高い中高生（16歳女子）

**ストーリー**：
```
友達との会話中に「今日どこ行く？」と聞かれる
スマホでリミメシを開く
お気に入り登録したチェーン（スタバ、マック）のメニューのみ表示する
「スタバで新しいフラペチーノ出てるよ！」と友達に提案
友達と一緒にスタバに行く
```

**受入基準**：
- お気に入り登録したチェーンのみの一覧表示ができる
- お気に入り未登録の場合は全チェーンの一覧が表示される
- お気に入り登録・解除が簡単にできる

### US-3：チェーン店別にメニューを確認したい

**ユーザー**：気分転換を求めるOL（28歳女性）

**ストーリー**：
```
通勤前に「今日はカフェで何を買おう」と考える
リミメシを開く
チェーン店別フィルタで「スターバックス」を選択
スタバの期間限定メニューと通常メニューが表示される
「新しいフラペチーノが出てるんだ、これにしよう」と決める
```

**受入基準**：
- チェーン店別でフィルタリングできる
- 選択したチェーンの期間限定メニューと通常メニューが表示される
- チェーンのロゴと公式サイトリンクが表示される

### US-4：メニューの詳細情報を確認したい

**ユーザー**：堅実派会社員（45歳男性）

**ストーリー**：
```
気になるメニューを見つける
メニューをタップして詳細ページを開く
メニュー名、説明、価格、販売期間、画像を確認
「値段も手頃だし、販売期間もまだあるから今度食べよう」と判断
```

**受入基準**：
- メニュー詳細ページにメニュー名、説明、価格、販売期間、画像が表示される
- 販売終了している可能性がある旨の注意書きが表示される
- チェーン店の公式サイトリンクが表示される

---

## 3. 受け入れ基準（Acceptance Criteria）

### AC-1：一覧表示の基本機能

- [ ] トップページに期間限定メニューが一覧表示される
- [ ] 各メニューカードにメニュー名、チェーン名、画像、価格が表示される
- [ ] 画像はテンプレアイコン（Phase2時点）
- [ ] 販売中のメニューのみが表示される（ステータス：販売中）
- [ ] メニューは新着順または更新日順で表示される
- [ ] スマートフォンでの表示が最適化されている（モバイルファースト）
- [ ] ローディング中は適切なスケルトンスクリーンが表示される

### AC-2：お気に入りフィルタリング

- [ ] ユーザーがお気に入り登録したチェーンのみの一覧表示ができる
- [ ] お気に入り未登録の場合は全チェーンの一覧が表示される
- [ ] お気に入り登録・解除が簡単にできる（ボタン1タップ）
- [ ] お気に入り登録には認証が必要（匿名認証でもOK）
- [ ] お気に入り状態はリアルタイムに反映される

### AC-3：チェーン店別フィルタリング

- [ ] チェーン店別でフィルタリングできる
- [ ] 選択したチェーンの期間限定メニューと通常メニューが表示される
- [ ] チェーンのロゴ、チェーン名、公式サイトリンクが表示される
- [ ] チェーンに登録されているタグが表示される（例：「ハンバーガー」「カフェ」「丼」）
- [ ] チェーン詳細ページへの遷移ができる

### AC-4：メニュー詳細表示

- [ ] メニュー詳細ページにメニュー名、説明、価格、販売期間、画像が表示される
- [ ] 説明、価格、販売期間は任意項目のため、未入力の場合は「情報なし」と表示
- [ ] 販売終了している可能性がある旨の注意書きが表示される
- [ ] チェーン店の公式サイトリンクが表示される
- [ ] メニュータイプ（期間限定 / 通常）が表示される
- [ ] 販売期間の終了日が未定の場合は「未定」と表示

### AC-5：エラーハンドリング

- [ ] データ取得エラー時は適切なエラーメッセージが表示される
- [ ] 該当するメニューがない場合は「メニューがありません」と表示される
- [ ] ネットワークエラー時はリトライボタンが表示される

### AC-6：パフォーマンス

- [ ] 初回ロード時間が3秒以内
- [ ] ページネーションまたは無限スクロール実装（1ページあたり20件程度）
- [ ] 画像は遅延読み込み（lazy loading）
- [ ] Firestoreクエリは最適化されている（インデックス活用）

### AC-7：アクセシビリティ

- [ ] セマンティックHTMLを使用
- [ ] キーボード操作が可能
- [ ] カラーコントラストがWCAG2.1 AA準拠
- [ ] スクリーンリーダーでの読み上げに対応

---

## 4. 技術仕様（Technical Specification）

### 4-1. データモデル

#### Menus（メニュー）

```typescript
interface Menu {
  id: string; // メニューID（自動生成）
  chainId: string; // 所属チェーンID（外部キー）
  name: string; // メニュー名（必須）
  description?: string; // 説明（任意）
  price?: number; // 価格（任意、円単位）
  imageUrl?: string; // 画像URL（任意）
  imageType: 'template' | 'official'; // 画像タイプ（テンプレート / 公式）
  menuType: 'limited' | 'regular'; // メニュータイプ（期間限定 / 通常）
  salesPeriod?: {
    startDate?: Date; // 開始日（任意）
    endDate?: Date; // 終了日（任意、未定の場合はnull）
  };
  status: 'on_sale' | 'ended' | 'scheduled'; // ステータス（販売中 / 販売終了 / 予定）
  createdAt: Date; // 作成日時
  updatedAt: Date; // 更新日時
}
```

#### Chains（チェーン店）

```typescript
interface Chain {
  id: string; // チェーンID（自動生成）
  name: string; // チェーン名
  tagIds: string[]; // タグID（配列、複数タグ対応）
  officialUrl?: string; // 公式サイトURL（任意）
  logoUrl?: string; // ロゴ画像URL（任意）
  createdAt: Date; // 作成日時
  updatedAt: Date; // 更新日時
}
```

#### Favorites（お気に入り）

```typescript
interface Favorite {
  id: string; // お気に入りID（自動生成）
  userId: string; // ユーザーID（外部キー）
  chainId: string; // チェーンID（外部キー）
  createdAt: Date; // 登録日時
}
```

#### Tags（タグ）

```typescript
interface Tag {
  id: string; // タグID（自動生成）
  name: string; // タグ名（例：「ハンバーガー」「カフェ」「丼」）
  displayOrder: number; // 表示順
  createdAt: Date; // 作成日時
}
```

### 4-2. Firestoreコレクション設計

```
/menus/{menuId}
/chains/{chainId}
/tags/{tagId}
/users/{userId}/favorites/{favoriteId}
```

### 4-3. Firestoreクエリ

#### 期間限定メニュー一覧取得

```typescript
// 全チェーンの期間限定メニューを取得（販売中のみ、更新日順）
const menusQuery = query(
  collection(db, 'menus'),
  where('menuType', '==', 'limited'),
  where('status', '==', 'on_sale'),
  orderBy('updatedAt', 'desc'),
  limit(20)
);
```

#### お気に入りチェーンのメニュー取得

```typescript
// お気に入り登録したチェーンIDを取得
const favoritesQuery = query(
  collection(db, `users/${userId}/favorites`)
);
const favoritesSnapshot = await getDocs(favoritesQuery);
const favoriteChainIds = favoritesSnapshot.docs.map(doc => doc.data().chainId);

// お気に入りチェーンの期間限定メニューを取得
const menusQuery = query(
  collection(db, 'menus'),
  where('chainId', 'in', favoriteChainIds), // 最大10件まで
  where('menuType', '==', 'limited'),
  where('status', '==', 'on_sale'),
  orderBy('updatedAt', 'desc'),
  limit(20)
);
```

#### チェーン別メニュー取得

```typescript
// 特定チェーンのメニューを取得（期間限定 + 通常）
const menusQuery = query(
  collection(db, 'menus'),
  where('chainId', '==', chainId),
  where('status', '==', 'on_sale'),
  orderBy('menuType', 'asc'), // 期間限定を優先
  orderBy('updatedAt', 'desc')
);
```

### 4-4. インデックス設計

Phase1-4（データモデル詳細設計）で詳細化予定

必要なインデックス（概要）：
- `menus`コレクション：`menuType` + `status` + `updatedAt`
- `menus`コレクション：`chainId` + `status` + `menuType` + `updatedAt`

### 4-5. セキュリティルール

Phase1-4（データモデル詳細設計）で詳細化予定

基本方針：
- メニュー、チェーン、タグは全ユーザーが読み取り可能
- お気に入りは自分のデータのみ読み書き可能
- メニュー、チェーン、タグの書き込みは管理者のみ

### 4-6. コンポーネント設計

```
pages/
├── MenuListPage.tsx               # トップページ（メニュー一覧）
├── MenuDetailPage.tsx             # メニュー詳細ページ
└── ChainDetailPage.tsx            # チェーン詳細ページ

components/
├── MenuCard.tsx                   # メニューカード（一覧表示用）
├── MenuDetail.tsx                 # メニュー詳細表示
├── ChainHeader.tsx                # チェーンヘッダー（ロゴ、名前、リンク）
├── FilterBar.tsx                  # フィルタバー（お気に入り、チェーン別）
├── ErrorMessage.tsx               # エラーメッセージ
├── LoadingSpinner.tsx             # ローディングスピナー
└── SkeletonMenuCard.tsx           # スケルトンスクリーン

hooks/
├── useMenuList.ts                 # メニュー一覧取得フック
├── useMenuDetail.ts               # メニュー詳細取得フック
├── useChainDetail.ts              # チェーン詳細取得フック
└── useFavorites.ts                # お気に入り管理フック
```

### 4-7. 状態管理

- React Context API または Zustand を使用
- 認証状態（Firebase Authentication）
- お気に入り状態（Firestore）
- フィルタ状態（ローカルステート）

### 4-8. ルーティング

```
/                   # メニュー一覧（トップページ）
/menus/:menuId      # メニュー詳細
/chains/:chainId    # チェーン詳細
```

---

## 5. UI/UX設計（UI/UX Design）

### 5-1. 画面構成

#### トップページ（メニュー一覧）

```
+----------------------------------+
| リミメシ                    [☰] |
+----------------------------------+
| [全て] [お気に入り] [チェーン▼] | ← フィルタバー
+----------------------------------+
| +------------------------------+ |
| | [画像]                       | |
| | 月見バーガー               [♥]| | ← メニューカード
| | マクドナルド                 | |
| | ¥390 | 9/1〜10/31            | |
| +------------------------------+ |
| +------------------------------+ |
| | [画像]                       | |
| | チゲ味噌ラーメン           [♥]| |
| | 日高屋                       | |
| | ¥690 | 期間未定              | |
| +------------------------------+ |
| ...                              |
+----------------------------------+
```

#### メニュー詳細ページ

```
+----------------------------------+
| [←] メニュー詳細          [♥]  |
+----------------------------------+
| [画像（大）]                     |
|                                  |
| 月見バーガー                     |
| マクドナルド                     |
+----------------------------------+
| ¥390                             |
| 販売期間：2025/9/1〜2025/10/31   |
|                                  |
| 説明：                           |
| 秋の定番、月見バーガーが今年も... |
|                                  |
| ⚠️ 販売終了している可能性があり   |
| ます。詳細は店舗にご確認ください。|
|                                  |
| [公式サイトを見る]               |
+----------------------------------+
```

#### チェーン詳細ページ

```
+----------------------------------+
| [←] マクドナルド          [♥]  |
+----------------------------------+
| [ロゴ画像]                       |
| マクドナルド                     |
| タグ：ハンバーガー               |
| [公式サイトを見る]               |
+----------------------------------+
| 期間限定メニュー                 |
+----------------------------------+
| +------------------------------+ |
| | [画像] 月見バーガー          | |
| | ¥390 | 9/1〜10/31            | |
| +------------------------------+ |
| +------------------------------+ |
| | [画像] グラコロ              | |
| | ¥340 | 12/1〜1/31            | |
| +------------------------------+ |
+----------------------------------+
| 通常メニュー                     |
+----------------------------------+
| +------------------------------+ |
| | [画像] ビッグマック          | |
| | ¥450 | 通年                  | |
| +------------------------------+ |
| ...                              |
+----------------------------------+
```

### 5-2. インタラクション

#### メニューカード

- タップでメニュー詳細ページに遷移
- お気に入りボタン（♥）タップでお気に入り登録・解除
- お気に入り未登録時は♡（白抜き）、登録時は♥（塗りつぶし）

#### フィルタバー

- 「全て」：全チェーンのメニューを表示
- 「お気に入り」：お気に入り登録したチェーンのメニューのみ表示
- 「チェーン▼」：チェーン別フィルタ（ドロップダウンまたはモーダル）

#### エラー時

- データ取得エラー：「データの取得に失敗しました。もう一度お試しください。」 + リトライボタン
- 該当メニューなし：「該当するメニューがありません。」

### 5-3. デザイン方針

- モバイルファースト（スマートフォン最適化）
- シンプルで視認性の高いデザイン
- カラーコントラストWCAG2.1 AA準拠
- TailwindCSSまたはMaterial-UIを使用
- 画像はWebP形式で最適化
- テンプレアイコンは月見系、グラコロ系、カレー系などカテゴリ別に用意（Phase2時点）

---

## 6. テスト計画（Test Plan）

### 6-1. 単体テスト

#### 対象

- カスタムフック（useMenuList, useMenuDetail, useChainDetail, useFavorites）
- ユーティリティ関数（日付フォーマット、価格フォーマットなど）

#### ツール

- Jest、Vitest

#### テストケース例

```typescript
describe('useMenuList', () => {
  it('期間限定メニューを取得できる', async () => {
    // テスト実装
  });

  it('お気に入りチェーンのメニューのみ取得できる', async () => {
    // テスト実装
  });

  it('データ取得エラー時に適切なエラー状態を返す', async () => {
    // テスト実装
  });
});
```

### 6-2. E2Eテスト

#### 対象

- メニュー一覧表示
- メニュー詳細表示
- チェーン詳細表示
- お気に入り登録・解除
- フィルタリング

#### ツール

- Playwright、Cypress

#### テストシナリオ例

```typescript
test('メニュー一覧が表示される', async ({ page }) => {
  await page.goto('/');
  await expect(page.locator('.menu-card')).toHaveCount(20);
});

test('メニュー詳細が表示される', async ({ page }) => {
  await page.goto('/');
  await page.click('.menu-card:first-child');
  await expect(page.locator('h1')).toContainText('月見バーガー');
});

test('お気に入り登録・解除ができる', async ({ page }) => {
  await page.goto('/');
  await page.click('.favorite-button:first-child');
  await expect(page.locator('.favorite-button:first-child')).toHaveClass(/active/);
});
```

### 6-3. 負荷テスト

#### 対象

- メニュー一覧取得のパフォーマンス
- Firestoreクエリの最適化確認
- 想定ユーザー数（DAU 1,000人、10,000人、100,000人）でのレスポンス時間

#### ツール

- Artillery、k6、Firebase Emulator

#### テストシナリオ

- 同時接続数：100、1,000、10,000
- リクエスト数：1,000リクエスト/分
- 目標レスポンス時間：1秒以内（p95）

### 6-4. アクセシビリティテスト

#### 対象

- セマンティックHTML
- キーボード操作
- カラーコントラスト
- スクリーンリーダー対応

#### ツール

- axe DevTools
- Lighthouse

#### 確認項目

- [ ] セマンティックHTMLを使用（header, main, nav, article, section）
- [ ] キーボード操作が可能（Tab、Enter、Escapeキー）
- [ ] カラーコントラストがWCAG2.1 AA準拠
- [ ] スクリーンリーダーでの読み上げに対応（aria-label、alt属性）

### 6-5. テストカバレッジ目標

- 単体テスト：70%以上
- E2Eテスト：主要なユーザーフロー（5シナリオ以上）
- 負荷テスト：Phase2リリース前必須
- アクセシビリティテスト：Lighthouse スコア90以上

---

## 7. 非機能要件（Non-Functional Requirements）

### 7-1. パフォーマンス

- 初回ロード時間：3秒以内
- ページ遷移：1秒以内
- Firestoreクエリ：500ms以内
- 画像読み込み：遅延読み込み（lazy loading）

### 7-2. スケーラビリティ

- 想定ユーザー数：Phase2で100〜1,000人、Phase3で1,000〜10,000人
- Firebaseの自動スケーリングに依存
- ページネーションまたは無限スクロール実装

### 7-3. セキュリティ

- Firebase Security Rulesでアクセス制御
- 匿名認証をデフォルト、Googleログインに移行可能
- お気に入りは自分のデータのみ読み書き可能

### 7-4. 信頼性

- エラーハンドリング：データ取得エラー、ネットワークエラー
- ユーザーへの注意書き：「販売終了している可能性があります。詳細は店舗にご確認ください。」
- リトライ機能：ネットワークエラー時

### 7-5. 保守性

- TypeScriptで型安全性を確保
- ESLint、Prettierでコードスタイル統一
- Storybookでコンポーネントカタログを作成
- 単体テスト・E2Eテストを実装と同時に作成

---

## 8. 残課題（TBD）

### Phase1で検討

- [ ] ページネーション vs 無限スクロールの選定
- [ ] 画像の遅延読み込み実装方法
- [ ] Firestoreインデックス設計の詳細化（data-model/indexes.md）
- [ ] Security Rulesの詳細化（data-model/security-rules.md）
- [ ] テストデータの作成方法

### Phase2で実装

- [ ] テンプレアイコンのデザイン作成（月見系、グラコロ系、カレー系など）
- [ ] フィルタUIの詳細設計（ドロップダウン vs モーダル）
- [ ] エラーメッセージの文言最終化
- [ ] 負荷テストの実施とパフォーマンスチューニング

### Phase3以降で追加

- [ ] 位置情報検索機能との連携
- [ ] タグ別フィルタリング
- [ ] 販売終了予定メニューの強調表示
- [ ] ユーザーからの販売終了報告機能

---

## 9. 参考資料

- [planning/first-idea.md](../planning/first-idea.md)：サービス全体像、ペルソナ、データモデル
- [planning/lean-canvas.md](../planning/lean-canvas.md)：ビジネスモデル、ターゲットユーザー
- [planning/inception-deck.md](../planning/inception-deck.md)：ユーザージャーニー、優先順位
- [WRITING_STYLE_GUIDE.md](../WRITING_STYLE_GUIDE.md)：ドキュメント記述ルール

---

## 更新履歴

- 2025/10/26：初版作成
